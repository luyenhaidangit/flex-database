-- ROLES & ROLE_REQUESTS & AUDIT TRAIL

-- =============================
-- CREATE ROLE_REQUESTS TABLE
-- =============================
create table ROLE_REQUESTS
(
    ID             NUMBER(19)        generated by default on null as identity primary key,
    ENTITY_ID      NUMBER(19),
    ACTION         VARCHAR2(20 char) not null,
    STATUS         VARCHAR2(10 char) default 'PENDING' not null,
    REQUESTED_DATA CLOB not null,
    COMMENTS       NVARCHAR2(500),
    MAKER_ID       VARCHAR2(256 char) not null,
    REQUESTED_DATE TIMESTAMP(6) default CURRENT_TIMESTAMP not null,
    CHECKER_ID     VARCHAR2(256 char),
    APPROVE_DATE   TIMESTAMP(6)
)
/

create index IX_ROLE_REQUESTS_ENTITY_ID on ROLE_REQUESTS (ENTITY_ID)
/
create index IX_ROLE_REQUESTS_STATUS on ROLE_REQUESTS (STATUS)
/
create index IX_ROLE_REQUESTS_MAKER_ID on ROLE_REQUESTS (MAKER_ID)
/
create index IX_ROLE_REQUESTS_CHECKER_ID on ROLE_REQUESTS (CHECKER_ID)
/

-- =============================
-- CREATE ROLES TABLE (ĐÃ GỘP CÁC TRƯỜNG MỚI)
-- =============================
create table ROLES
(
    ID                NUMBER(19) generated by default on null as identity primary key,
    NAME              VARCHAR2(256 char) not null unique,
    NORMALIZED_NAME   VARCHAR2(256 char) unique,
    CONCURRENCY_STAMP VARCHAR2(256 char),
    CODE              VARCHAR2(255 char) not null unique,
    DESCRIPTION       VARCHAR2(1000 char) default '',
    IS_ACTIVE         CHAR default 'Y' check (IS_ACTIVE IN ('Y', 'N')),
    CREATED_AT        TIMESTAMP(6) default CURRENT_TIMESTAMP not null,
    LAST_UPDATED      TIMESTAMP(6),
    STATUS            VARCHAR2(20) DEFAULT 'APPROVED' CHECK (STATUS IN ('DRAFT', 'PENDING', 'APPROVED', 'REJECTED')),
    MAKER_ID          VARCHAR2(256 CHAR),
    CHECKER_ID        VARCHAR2(256 CHAR)
)
/

create index IX_ROLES_STATUS on ROLES(STATUS)
/
create index IX_ROLES_PARENT_ID on ROLES(PARENT_ID)
/
create index IX_ROLES_MAKER_ID on ROLES(MAKER_ID)
/
create index IX_ROLES_CHECKER_ID on ROLES(CHECKER_ID)
/
create index IX_ROLES_REQUEST_ID on ROLES(REQUEST_ID)
/

-- =============================
-- CREATE ROLE_AUDIT_TRAIL TABLE
-- =============================
CREATE TABLE ROLE_AUDIT_TRAIL (
    ID          NUMBER(19,0) GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ROLE_ID     NUMBER(19,0) NOT NULL REFERENCES ROLES(ID),
    REQUEST_ID  NUMBER(19,0) REFERENCES ROLE_REQUESTS(ID),
    ACTION      VARCHAR2(20 CHAR) NOT NULL CHECK (ACTION IN ('CREATE', 'UPDATE', 'DELETE', 'ACTIVATE', 'DEACTIVATE', 'APPROVE', 'REJECT')),
    OLD_VALUES  CLOB, -- JSON of old values
    NEW_VALUES  CLOB, -- JSON of new values
    CHANGED_BY  VARCHAR2(256 CHAR) NOT NULL,
    CHANGED_AT  TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    COMMENTS    NVARCHAR2(500),
    IP_ADDRESS  VARCHAR2(45 CHAR),
    USER_AGENT  VARCHAR2(500 CHAR)
)
/

CREATE INDEX IX_ROLE_AUDIT_TRAIL_ROLE_ID ON ROLE_AUDIT_TRAIL(ROLE_ID)
/
CREATE INDEX IX_ROLE_AUDIT_TRAIL_REQUEST_ID ON ROLE_AUDIT_TRAIL(REQUEST_ID)
/
CREATE INDEX IX_ROLE_AUDIT_TRAIL_CHANGED_BY ON ROLE_AUDIT_TRAIL(CHANGED_BY)
/
CREATE INDEX IX_ROLE_AUDIT_TRAIL_CHANGED_AT ON ROLE_AUDIT_TRAIL(CHANGED_AT DESC)
/
CREATE INDEX IX_ROLE_AUDIT_TRAIL_ACTION ON ROLE_AUDIT_TRAIL(ACTION)
/

-- =============================
-- COMMENTS FOR DOCUMENTATION
-- =============================
COMMENT ON TABLE ROLES IS 'Roles table with draft/approval support';
COMMENT ON COLUMN ROLES.STATUS IS 'Role status: DRAFT, PENDING, APPROVED, REJECTED';
COMMENT ON COLUMN ROLES.MAKER_ID IS 'User who created/modified the role';
COMMENT ON COLUMN ROLES.CHECKER_ID IS 'User who approved/rejected the role';

COMMENT ON TABLE ROLE_REQUESTS IS 'Role approval requests for maker-checker workflow';
COMMENT ON COLUMN ROLE_REQUESTS.STATUS IS 'Request status: DRAFT, PENDING, APPROVED, REJECTED, CANCELLED';
COMMENT ON COLUMN ROLE_REQUESTS.ACTION IS 'Action type: CREATE, UPDATE, DELETE, ACTIVATE, DEACTIVATE';
COMMENT ON COLUMN ROLE_REQUESTS.REQUESTED_DATA IS 'JSON data containing role information';

COMMENT ON TABLE ROLE_AUDIT_TRAIL IS 'Audit trail for all role changes';
COMMENT ON COLUMN ROLE_AUDIT_TRAIL.OLD_VALUES IS 'JSON of previous values before change';
COMMENT ON COLUMN ROLE_AUDIT_TRAIL.NEW_VALUES IS 'JSON of new values after change';

-- =============================
-- PERMISSONS
-- =============================
CREATE TABLE PERMISSIONS (
    ID           NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CODE                    VARCHAR2(150) UNIQUE NOT NULL,
    NAME                    NVARCHAR2(200) NOT NULL,
    DESCRIPTION             NVARCHAR2(500),
    PARENT_PERMISSION_ID    NUMBER,
    IS_ASSIGNABLE           NUMBER(1) DEFAULT 1 NOT NULL,
    SORT_ORDER              NUMBER NOT NULL,
    IS_ACTIVE               NUMBER(1) NOT NULL,
    CONSTRAINT FK_PERMISSIONS_PARENT FOREIGN KEY (PARENT_PERMISSION_ID) REFERENCES PERMISSIONS(PERMISSION_ID)
);
/