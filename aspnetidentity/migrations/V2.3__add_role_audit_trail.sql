-- SCRIPT: V2.3_add_role_audit_trail.sql - Add Role Audit Trail

-- ================================================
-- CREATE ROLE_AUDIT_TRAIL TABLE FOR TRACKING CHANGES
-- ================================================
CREATE TABLE ROLE_AUDIT_TRAIL (
    ID                    NUMBER(19,0) GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ROLE_ID               NUMBER(19,0) NOT NULL REFERENCES ROLES(ID),
    REQUEST_ID            NUMBER(19,0) REFERENCES ROLE_REQUESTS(ID),
    ACTION                VARCHAR2(20 CHAR) NOT NULL CHECK (ACTION IN ('CREATE', 'UPDATE', 'DELETE', 'ACTIVATE', 'DEACTIVATE', 'APPROVE', 'REJECT')),
    OLD_VALUES            CLOB, -- JSON of old values
    NEW_VALUES            CLOB, -- JSON of new values
    CHANGED_BY            VARCHAR2(256 CHAR) NOT NULL,
    CHANGED_AT            TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    COMMENTS              NVARCHAR2(500),
    IP_ADDRESS            VARCHAR2(45 CHAR),
    USER_AGENT            VARCHAR2(500 CHAR)
);

-- Create indexes for audit trail
CREATE INDEX IX_ROLE_AUDIT_TRAIL_ROLE_ID ON ROLE_AUDIT_TRAIL(ROLE_ID);
CREATE INDEX IX_ROLE_AUDIT_TRAIL_REQUEST_ID ON ROLE_AUDIT_TRAIL(REQUEST_ID);
CREATE INDEX IX_ROLE_AUDIT_TRAIL_CHANGED_BY ON ROLE_AUDIT_TRAIL(CHANGED_BY);
CREATE INDEX IX_ROLE_AUDIT_TRAIL_CHANGED_AT ON ROLE_AUDIT_TRAIL(CHANGED_AT DESC);
CREATE INDEX IX_ROLE_AUDIT_TRAIL_ACTION ON ROLE_AUDIT_TRAIL(ACTION);

-- ================================================
-- ADD COMMENTS FOR DOCUMENTATION
-- ================================================
COMMENT ON TABLE ROLES IS 'Roles table with draft/approval support';
COMMENT ON COLUMN ROLES.STATUS IS 'Role status: DRAFT, PENDING, APPROVED, REJECTED';
COMMENT ON COLUMN ROLES.VERSION IS 'Version number for role changes';
COMMENT ON COLUMN ROLES.PARENT_ID IS 'Reference to parent role (for drafts)';
COMMENT ON COLUMN ROLES.MAKER_ID IS 'User who created/modified the role';
COMMENT ON COLUMN ROLES.CHECKER_ID IS 'User who approved/rejected the role';
COMMENT ON COLUMN ROLES.REQUEST_ID IS 'Reference to ROLE_REQUESTS table';

COMMENT ON TABLE ROLE_REQUESTS IS 'Role approval requests for maker-checker workflow';
COMMENT ON COLUMN ROLE_REQUESTS.STATUS IS 'Request status: DRAFT, PENDING, APPROVED, REJECTED, CANCELLED';
COMMENT ON COLUMN ROLE_REQUESTS.ACTION IS 'Action type: CREATE, UPDATE, DELETE, ACTIVATE, DEACTIVATE';
COMMENT ON COLUMN ROLE_REQUESTS.REQUESTED_DATA IS 'JSON data containing role information';

COMMENT ON TABLE ROLE_AUDIT_TRAIL IS 'Audit trail for all role changes';
COMMENT ON COLUMN ROLE_AUDIT_TRAIL.OLD_VALUES IS 'JSON of previous values before change';
COMMENT ON COLUMN ROLE_AUDIT_TRAIL.NEW_VALUES IS 'JSON of new values after change';
/ 