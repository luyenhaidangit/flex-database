# flex-database

Repository dùng để quản lý script database cho dự án **flex**. Mỗi thư mục con ứng với một cơ sở dữ liệu hoặc môi trường cần quản lý. Các script được tổ chức theo chuẩn [Flyway](https://flywaydb.org/).

## Cấu trúc thư mục

- `aspnetidentity/` – chứa script cho database quản lý người dùng.
- `investordb/` – script liên quan đến dữ liệu nhà đầu tư.
- `systemdb/` – lưu trữ cấu hình hệ thống.
- `redisdb/` – các file cấu hình/seed cho Redis.
- `wallet/` – tệp cấu hình kết nối Oracle (wallet files).

Trong mỗi thư mục (trừ `wallet`) có 2 thư mục chính:

- `migrations/` – chứa script tạo/chỉnh sửa cấu trúc dữ liệu.
- `seeders/` – script để insert dữ liệu mặc định.

## Quy ước đặt tên file

Các file migration và seeder đang tuân theo mẫu `V<major>.<minor>__<mo-ta>.sql` (ví dụ: `V1.2__create_table_roles.sql`). Quy ước này giúp Flyway chạy script theo đúng thứ tự. Một số điểm cần lưu ý:

1. Sử dụng số phiên bản tăng dần (`V1.1`, `V1.2` ...). Phần mô tả (`<mo-ta>`) nên viết bằng tiếng Anh, dạng `snake_case` để dễ đọc.
2. Với Redis, file có thể mang đuôi `.sh` hoặc `.txt` tùy mục đích nhưng vẫn nên giữ tiền tố `V<major>.<minor>__`.

Ví dụ tên file phù hợp:

```
V1.1__create_table_users.sql
V1.2__seed_table_users.sql
V2.0__seed_auth_mode.sh
```

## Quy tắc viết script SQL

- Từ khóa SQL viết hoa, tên bảng/cột đặt trong cặp `""` nếu chứa ký tự đặc biệt hoặc trùng từ khóa. Ví dụ:

```sql
CREATE TABLE "Users" (
    "Id" NUMBER(19) GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    "UserName" NVARCHAR2(256)
);
```

- Cuối mỗi câu lệnh cần kết thúc bằng `/` để Flyway hoặc SQL*Plus thực thi chính xác.
- File seeder nên có `COMMIT;` trước `/` để đảm bảo dữ liệu được ghi lại.

## Template migration

```sql
-- ================================================
-- SCRIPT: V1.0__create_table_example.sql - <ngay/thang/nam>
-- ================================================

CREATE TABLE EXAMPLE (
    ID NUMBER(19) GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NAME VARCHAR2(100) NOT NULL
);
/
```

## Template seeder

```sql
INSERT INTO EXAMPLE (NAME) VALUES ('Sample');
COMMIT;
/
```

## Template seed cho Redis

```bash
# V1.0__seed_auth_mode.sh
SET CONFIG:AUTH_MODE "DB"
```

Các script Redis có thể dùng cú pháp của Redis CLI hoặc ghi chú cấu trúc dữ liệu như thư mục `redisdb/configs`.

## Đề xuất cải tiến

- **Thống nhất chữ hoa/thường**: hiện tại một số file dùng `CREATE TABLE Users` (PascalCase) trong khi nơi khác dùng `CREATE TABLE USERS`. Nên thống nhất viết hoa toàn bộ tên bảng để phù hợp chuẩn Oracle.
- **Mô tả file rõ ràng**: nên dùng tiếng Anh và từ khóa ngắn gọn, ví dụ `create_table_orders` thay vì `create_table_order` (nếu bảng lưu nhiều bản ghi).
- **Bổ sung script kiểm thử**: cân nhắc tạo thư mục `tests/` chứa script kiểm thử hoặc hướng dẫn chạy Flyway.

